<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>åœ‹äºŒä¸€ä¾¿ç•¶è¨‚è³¼ç³»çµ±å¾Œå°</title>
<link rel="stylesheet" href="./style.css">
<style>
body { font-family: Arial, sans-serif; background:#0b0f14; color:#cfe9ff; margin:0; padding:20px; }
header { display:flex; justify-content:space-between; align-items:center; padding:10px 20px; background:#111824; }
.logo { font-size:1.5em; font-weight:bold; }
.header-buttons { display:flex; gap:10px; }
.admin-link, .logout-btn { color:#cfe9ff; text-decoration:none; font-size:1em; font-weight:bold; background:#2196f3; padding:6px 12px; border-radius:4px; cursor:pointer; display:inline-flex; align-items:center; justify-content:center; height:36px; }
.logout-btn:hover, .admin-link:hover { opacity:0.9; }

.delete-btn { background:red; color:#fff; border:none; padding:4px 8px; border-radius:4px; cursor:pointer; }
.delete-btn:hover { background:#a80000; }
table { border-collapse: collapse; width:100%; margin-top:15px; }
th, td { border:1px solid #37b7ff; padding:5px; text-align:center; }
#dailyStatsSection { margin-top:30px; }
footer { margin-top:30px; font-size:0.8em; color:#888; }

/* è¼¸å…¥æ¡†æ¨£å¼ */
.input-field {
  width: 250px;
  padding: 8px 12px;
  margin: 5px 0;
  border-radius: 6px;
  border: 1px solid #37b7ff;
  background: #111824;
  color: #cfe9ff;
}

/* ç™»å…¥æŒ‰éˆ• */
.login-btn {
  padding: 8px 20px;
  margin-top: 10px;
  border: none;
  border-radius: 6px;
  background-color: #4caf50;
  color: white;
  font-size: 14px;
  cursor: pointer;
}
.login-btn:hover { opacity: 0.9; }

/* é€å–®æ¨¡å¼å€å¡Š */
#orderModeSection { margin-top:30px; border:1px solid #37b7ff; padding:15px; border-radius:6px; }
#orderModeSection label { margin-right:10px; }
#orderModeSection input[type="date"], #orderModeSection input[type="datetime-local"] { background:#111824; color:#cfe9ff; border:1px solid #37b7ff; border-radius:6px; padding:4px 8px; }
#orderModeSection button { margin-top:10px; padding:6px 12px; border:none; border-radius:6px; background:#2196f3; color:white; cursor:pointer; }
#orderModeSection button:hover { opacity:0.9; }
</style>
  <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-5848732938514032"
     crossorigin="anonymous"></script>
</head>
<body>

<header>
  <div class="logo">å¾Œå°ç®¡ç† - åœ‹äºŒä¸€ä¾¿ç•¶è¨‚è³¼ç³»çµ±</div>
  <div class="header-buttons">
    <a href="./index.html" class="admin-link">è¿”å›å‰å°</a>
    <span class="logout-btn" id="logoutBtn" style="display:none;">ç™»å‡º</span>
  </div>
</header>

<main>
  <!-- ç™»å…¥å€ -->
  <div id="loginSection">
    <h2>ç®¡ç†å“¡ç™»å…¥</h2>
    <input type="text" id="adminUser" placeholder="å¸³è™Ÿ" class="input-field"><br>
    <input type="password" id="adminPass" placeholder="å¯†ç¢¼" class="input-field"><br>
    <button id="loginBtn" class="login-btn">ç™»å…¥</button>
    <div id="loginMsg" style="color:red; margin-top:10px;"></div>
  </div>

  <!-- å¾Œå°çµ±è¨ˆå€ -->
  <div id="adminPanel" style="display:none;">
    <h2>æ‰€æœ‰è¨‚å–®çµ±è¨ˆ</h2>
    <div id="statsResult"></div>

    <div id="dailyStatsSection">
      <h2>æ¯æ—¥è¨‚å–®çµ±è¨ˆ</h2>
      <div id="dailyStatsResult" style="margin-top:15px;"></div>
    </div>

    <button id="deleteAllBtn" class="delete-btn" style="margin-top:15px;">åˆªé™¤å…¨éƒ¨è¨‚å–®</button>

    <!-- ===== é€å–®æ¨¡å¼è¨­å®š ===== -->
    <div id="orderModeSection">
      <h2>åŠŸèƒ½è¨­å®š</h2>
      
      <!-- æ‰‹å‹•é–‹é—œ -->
      <label>
        <input type="checkbox" id="orderOpen"> é–‹æ”¾é€å–®
      </label><br>

      <!-- è‡ªå‹•é—œé–‰è¨­å®š -->
      <h3 style="margin-top:15px;">è‡ªå‹•é—œé–‰é€å–®</h3>
      <label>
        é—œé–‰æ—¥æœŸèˆ‡æ™‚é–“ï¼š
        <input type="datetime-local" id="closeDateTime">
      </label><br>

      <!-- ç›®å‰ç‹€æ…‹é¡¯ç¤º -->
      <p id="currentStatus" style="margin-top:5px; color:#ff9800;">ç›®å‰é€å–®ç‹€æ…‹ï¼šæœªçŸ¥</p>

      <button id="saveOrderModeBtn">å„²å­˜è¨­å®š</button>
      <div id="orderModeMsg" style="color:#ff9800; margin-top:10px;"></div>
    </div>
  </div>
</main>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const loginSection = document.getElementById("loginSection");
  const adminPanel = document.getElementById("adminPanel");
  const loginBtn = document.getElementById("loginBtn");
  const loginMsg = document.getElementById("loginMsg");
  const logoutBtn = document.getElementById("logoutBtn");

  let inactivityTimer = null;
  const INACTIVITY_LIMIT = 10 * 60 * 1000; // 10åˆ†é˜
  const mealTypes = ["æ­£åœ’A","æ­£åœ’B","å¾¡é¥ŒA","å¾¡é¥ŒB","æ‚¦é¦¨","ä»Šæ—¥ä¸è¨‚è³¼"];
  const dayNames = ["ç¦®æ‹œä¸€","ç¦®æ‹œäºŒ","ç¦®æ‹œä¸‰","ç¦®æ‹œå››","ç¦®æ‹œäº”"];
  let allOrders = [];

  const orderOpenCheckbox = document.getElementById("orderOpen");
  const closeDateTime = document.getElementById("closeDateTime");
  const saveOrderModeBtn = document.getElementById("saveOrderModeBtn");
  const orderModeMsg = document.getElementById("orderModeMsg");
  const currentStatus = document.getElementById("currentStatus");
  const statsResult = document.getElementById("statsResult");
  const dailyStatsResult = document.getElementById("dailyStatsResult");
  const deleteAllBtn = document.getElementById("deleteAllBtn");

  // ===== è‡ªå‹•ç™»å‡º =====
  function resetInactivityTimer() {
    if(inactivityTimer) clearTimeout(inactivityTimer);
    inactivityTimer = setTimeout(() => {
      alert("å·²è¶…é10åˆ†é˜æœªæ“ä½œï¼Œç‚ºä¿è­·è³‡è¨Šå®‰å…¨ï¼Œç³»çµ±å·²è‡ªå‹•å°‡æ‚¨ç™»å‡º");
      logout();
    }, INACTIVITY_LIMIT);
  }

  ['click','mousemove','keydown','scroll'].forEach(evt => {
    document.addEventListener(evt, resetInactivityTimer);
  });

  function logout() {
    localStorage.removeItem("loginTime");
    adminPanel.style.display = "none";
    loginSection.style.display = "block";
    logoutBtn.style.display = "none";
  }

  logoutBtn.addEventListener("click", logout);

  // ===== ç™»å…¥åŠŸèƒ½ =====
  loginBtn.addEventListener("click", async () => {
    const username = document.getElementById("adminUser").value.trim();
    const password = document.getElementById("adminPass").value.trim();
    if(!username || !password){ loginMsg.textContent="è«‹è¼¸å…¥å¸³è™Ÿèˆ‡å¯†ç¢¼"; return; }

    try {
      const res = await fetch("/api/admin/login", {
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body:JSON.stringify({user:username, pass:password})
      });
      const data = await res.json();
      if(data.success){
        loginSection.style.display="none";
        adminPanel.style.display="block";
        logoutBtn.style.display = "inline-flex";
        loginMsg.textContent="";
        localStorage.setItem("loginTime", Date.now());
        resetInactivityTimer();
        loadOrders();
        loadOrderMode();
      } else loginMsg.textContent=data.message || "å¸³è™Ÿæˆ–å¯†ç¢¼éŒ¯èª¤";
    } catch(err){
      loginMsg.textContent = "ç™»å…¥å¤±æ•—ï¼š" + err.message;
    }
  });

  // ===== æª¢æŸ¥æ˜¯å¦å·²ç™»å…¥ =====
  const savedLogin = localStorage.getItem("loginTime");
  if(savedLogin && (Date.now() - savedLogin < INACTIVITY_LIMIT)){
    loginSection.style.display="none";
    adminPanel.style.display="block";
    logoutBtn.style.display = "inline-flex";
    resetInactivityTimer();
    loadOrders();
    loadOrderMode();
  }

  // ===== è¨‚å–®è¼‰å…¥/æ¸²æŸ“/åˆªé™¤ =====
  async function loadOrders(){
    try {
      const res = await fetch("/api/orders");
      const data = await res.json();
      if(data.success){
        allOrders = data.data;
        renderAllOrders(allOrders);
        renderDailyStats();
      }
    } catch(err){ alert("è¼‰å…¥è¨‚å–®å¤±æ•—ï¼š" + err.message); }
  }

  function renderAllOrders(orders){
    const seatMap = {};
    orders.forEach(o=>{
      const seat = o.seat;
      if(!seatMap[seat]) seatMap[seat]=[];
      seatMap[seat].push(o);
    });

    let html = `<table>
      <tr>
        <th>åº§è™Ÿ</th>
        <th>å“é …</th>
        <th>æ•¸é‡</th>
        <th>ç¸½é‡‘é¡</th>
        <th>æ“ä½œ</th>
      </tr>`;

    Object.keys(seatMap).forEach(seat=>{
      const items = seatMap[seat];
      const counts = {};
      items.forEach(i=>{
        i.items.forEach(it=>{
          counts[it.typeName] = (counts[it.typeName]||0)+1;
        });
      });
      const totalPrice = Object.keys(counts).reduce((sum,type)=>type!=="ä»Šæ—¥ä¸è¨‚è³¼"?sum+counts[type]*70:sum,0);
      let first = true;
      for(let type in counts){
        html += `<tr>
          ${first?`<td rowspan="${Object.keys(counts).length}">${seat}</td>`:""}
          <td>${type}</td>
          <td>${counts[type]}</td>
          ${first?`<td rowspan="${Object.keys(counts).length}">${totalPrice}</td>`:""}
          ${first?`<td rowspan="${Object.keys(counts).length}"><button class="delete-btn" data-seat="${seat}">åˆªé™¤</button></td>`:""}
        </tr>`;
        first=false;
      }
    });

    html += `</table>`;
    statsResult.innerHTML = html;
    bindDeleteButtons();
  }

  function bindDeleteButtons(){
    document.querySelectorAll(".delete-btn").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        const seat = btn.dataset.seat;
        if(confirm(`ç¢ºèªåˆªé™¤åº§è™Ÿ ${seat} çš„æ‰€æœ‰è¨‚å–®ï¼Ÿ`)){
          fetch("/api/orders", {
            method:"DELETE",
            headers:{"Content-Type":"application/json"},
            body:JSON.stringify({seat})
          })
          .then(res=>res.json())
          .then(d=>{ if(d.success){ alert("åˆªé™¤æˆåŠŸ"); loadOrders(); } else alert(d.message); });
        }
      });
    });
  }

  deleteAllBtn.addEventListener("click", ()=>{
    if(confirm("ç¢ºèªåˆªé™¤å…¨éƒ¨è¨‚å–®ï¼Ÿ")){
      fetch("/api/orders/all", { method:"DELETE" })
        .then(res=>res.json())
        .then(d=>{ if(d.success){ alert("å…¨éƒ¨è¨‚å–®å·²åˆªé™¤"); loadOrders(); } else alert(d.message); });
    }
  });

  function renderDailyStats(){
    if(allOrders.length === 0){
      dailyStatsResult.innerHTML = "<p>ç›®å‰æ²’æœ‰è³‡æ–™</p>";
      return;
    }
    let html = "";
    dayNames.forEach(day => {
      const ordersForDay = [];
      allOrders.forEach(order => {
        order.items.forEach(item => {
          if(item.day === day) ordersForDay.push(item);
        });
      });
      if(ordersForDay.length === 0) return;
      const counts = {};
      mealTypes.forEach(type => counts[type] = 0);
      ordersForDay.forEach(item => { counts[item.typeName] = (counts[item.typeName]||0)+1; });
      const totalCount = Object.keys(counts).reduce((sum,type)=> type!=="ä»Šæ—¥ä¸è¨‚è³¼"?sum+counts[type]:sum,0);
      const totalAmount = totalCount * 70;
      html += `<h3>${day}</h3>`;
      html += `<table>
        <tr><th>å“é …</th><th>æ•¸é‡</th><th>é‡‘é¡</th></tr>`;
      mealTypes.forEach(type => {
        if(counts[type] > 0 && type !== "ä»Šæ—¥ä¸è¨‚è³¼"){
          html += `<tr><td>${type}</td><td>${counts[type]}</td><td>${counts[type]*70}</td></tr>`;
        }
      });
      html += `<tr><td><b>ç¸½è¨ˆ</b></td><td><b>${totalCount}</b></td><td><b>${totalAmount}</b></td></tr>`;
      html += `</table><br>`;
    });
    dailyStatsResult.innerHTML = html;
  }

  // ===== é€å–®æ¨¡å¼è¨­å®š =====
  function loadOrderMode() {
    const saved = localStorage.getItem("orderMode");
    if(saved){
      try {
        const mode = JSON.parse(saved);
        orderOpenCheckbox.checked = mode.open ?? false;
        closeDateTime.value = mode.closeDateTime ?? "";
      } catch(e){}
    }
    updateOrderStatusDisplay();
  }

  function updateOrderStatusDisplay() {
    const now = new Date();
    const mode = JSON.parse(localStorage.getItem("orderMode") || "{}");
    let statusText = "âŒæœªé–‹æ”¾é€å–®";

    if(mode.open){
      if(mode.closeDateTime){
        const closeTime = new Date(mode.closeDateTime);
        if(now > closeTime){
          orderOpenCheckbox.checked = false;
          mode.open = false;
          localStorage.setItem("orderMode", JSON.stringify(mode));
          statusText = "âŒæœªé–‹æ”¾é€å–®";
        } else statusText = "âœ…é–‹æ”¾é€å–®";
      } else statusText = "âœ…é–‹æ”¾é€å–®";
    }

    currentStatus.textContent = "ç›®å‰é€å–®ç‹€æ…‹ï¼š" + statusText;
  }

  saveOrderModeBtn.addEventListener("click", ()=>{
    const mode = {
      open: orderOpenCheckbox.checked,
      closeDateTime: closeDateTime.value
    };
    localStorage.setItem("orderMode", JSON.stringify(mode));
    orderModeMsg.textContent = "ğŸ’¾è¨­å®šå·²å„²å­˜";
    updateOrderStatusDisplay();
    setTimeout(()=>orderModeMsg.textContent="",2000);
  });

  // åˆå§‹åŒ–
  loadOrderMode();
});
</script>

<footer style="text-align:center; font-size:0.8em; color:#888; margin:20px 0;">
  â€»å¦‚é‡éŒ¯èª¤é é¢åˆ·æ–°å³å¯ï¼Œéœ€æ›´æ”¹ä¾¿ç•¶æ•¸é‡æˆ–å…¶ä»–æ±è¥¿è«‹æ‰¾ç›¸é—œè‚¡é•·è™•ç†ï¼Œbugåé¥‹/å¿˜è¨˜å¸³è™Ÿå¯†ç¢¼ï¼Œè¯ç¹«æ–¹å¼(Gmail)ï¼šs11316021@fsvs.khc.edu.tw
</footer>

</body>
</html>
