<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>後台管理 - 國二一便當訂購系統</title>
<link rel="stylesheet" href="./style.css">
<style>
body { font-family: Arial, sans-serif; background:#0b0f14; color:#cfe9ff; margin:0; padding:20px; }
header { display:flex; justify-content:space-between; align-items:center; padding:10px 20px; background:#111824; }
.logo { font-size:1.5em; font-weight:bold; }
.header-buttons { display:flex; gap:10px; }
.admin-link, .logout-btn { color:#cfe9ff; text-decoration:none; font-size:1em; font-weight:bold; background:#2196f3; padding:6px 12px; border-radius:4px; cursor:pointer; display:inline-flex; align-items:center; justify-content:center; height:36px; }
.logout-btn:hover, .admin-link:hover { opacity:0.9; }

.delete-btn { background:red; color:#fff; border:none; padding:4px 8px; border-radius:4px; cursor:pointer; }
.delete-btn:hover { background:#a80000; }
table { border-collapse: collapse; width:100%; margin-top:15px; }
th, td { border:1px solid #37b7ff; padding:5px; text-align:center; }
#dailyStatsSection { margin-top:30px; }
footer { margin-top:30px; font-size:0.8em; color:#888; }

.input-field { width: 250px; padding: 8px 12px; margin: 5px 0; border-radius: 6px; border: 1px solid #37b7ff; background: #111824; color: #cfe9ff; }
.login-btn { padding: 8px 20px; margin-top: 10px; border: none; border-radius: 6px; background-color: #4caf50; color: white; font-size: 14px; cursor: pointer; }
.login-btn:hover { opacity: 0.9; }

#orderModeSection { margin-top:30px; border:1px solid #37b7ff; padding:15px; border-radius:6px; }
#orderModeSection label { margin-right:10px; }
#orderModeSection input[type="date"], #orderModeSection input[type="time"] { background:#111824; color:#cfe9ff; border:1px solid #37b7ff; border-radius:6px; padding:4px 8px; }
#orderModeSection button { margin-top:10px; padding:6px 12px; border:none; border-radius:6px; background:#2196f3; color:white; cursor:pointer; }
#orderModeSection button:hover { opacity:0.9; }
#orderStatus { font-size:1.1em; margin-bottom:10px; font-weight:bold; }
</style>
</head>
<body>

<header>
  <div class="logo">後台管理 - 國二一便當訂購系統</div>
  <div class="header-buttons">
    <a href="./index.html" class="admin-link">返回前台</a>
    <span class="logout-btn" id="logoutBtn" style="display:none;">登出</span>
  </div>
</header>

<main>
  <!-- 登入區 -->
  <div id="loginSection">
    <h2>管理員登入</h2>
    <input type="text" id="adminUser" placeholder="帳號" class="input-field"><br>
    <input type="password" id="adminPass" placeholder="密碼" class="input-field"><br>
    <button id="loginBtn" class="login-btn">登入</button>
    <div id="loginMsg" style="color:red; margin-top:10px;"></div>
  </div>

  <!-- 後台統計區 -->
  <div id="adminPanel" style="display:none;">
    <h2>所有訂單統計</h2>
    <div id="statsResult"></div>

    <div id="dailyStatsSection">
      <h2>每日訂單統計</h2>
      <div id="dailyStatsResult" style="margin-top:15px;"></div>
    </div>

    <button id="deleteAllBtn" class="delete-btn" style="margin-top:15px;">刪除全部訂單</button>

    <div id="orderModeSection">
      <h2>功能設定</h2>
      <div id="orderStatus">狀態讀取中...</div>
      <label><input type="checkbox" id="orderOpen"> 開放送單</label><br>

      <h3 style="margin-top:15px;">定時設定</h3>
      <label><input type="checkbox" id="scheduleEnabled"> 開啟定時設定</label><br>
      <label>執行日期：<input type="date" id="scheduleDate"></label><br>
      <label>執行時間：<input type="time" id="scheduleTime"></label><br>

      <button id="saveOrderModeBtn">儲存設定</button>
      <div id="orderModeMsg" style="color:#ff9800; margin-top:10px;"></div>
    </div>
  </div>
</main>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const loginSection = document.getElementById("loginSection");
  const adminPanel = document.getElementById("adminPanel");
  const loginBtn = document.getElementById("loginBtn");
  const logoutBtn = document.getElementById("logoutBtn");
  const loginMsg = document.getElementById("loginMsg");
  const statsResult = document.getElementById("statsResult");
  const dailyStatsResult = document.getElementById("dailyStatsResult");
  const orderOpenCheckbox = document.getElementById("orderOpen");
  const scheduleEnabled = document.getElementById("scheduleEnabled");
  const scheduleDate = document.getElementById("scheduleDate");
  const scheduleTime = document.getElementById("scheduleTime");
  const saveOrderModeBtn = document.getElementById("saveOrderModeBtn");
  const orderModeMsg = document.getElementById("orderModeMsg");
  const orderStatus = document.getElementById("orderStatus");
  const deleteAllBtn = document.getElementById("deleteAllBtn");

  const mealTypes = ["正園A","正園B","御饌A","御饌B","悦馨A","悦馨B","今日不訂購"];

  /** 登入 */
  loginBtn.addEventListener("click", async () => {
    const user = document.getElementById("adminUser").value.trim();
    const pass = document.getElementById("adminPass").value.trim();
    if(!user || !pass){ loginMsg.textContent="請輸入帳號與密碼"; return; }
    try {
      const res = await fetch("/api/admin/login", {
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body:JSON.stringify({ username:user, password:pass })
      });
      const data = await res.json();
      if(data.success){
        loginSection.style.display="none";
        adminPanel.style.display="block";
        logoutBtn.style.display="inline-block";
        loginMsg.textContent="";
        loadOrderMode();
        loadStats();
      } else { loginMsg.textContent="登入失敗：" + (data.message||"帳號或密碼錯誤"); }
    } catch(err){ loginMsg.textContent="連線失敗"; }
  });

  /** 登出 */
  logoutBtn.addEventListener("click", async ()=>{
    await fetch("/api/admin/logout", { method:"POST" });
    adminPanel.style.display="none";
    loginSection.style.display="block";
    logoutBtn.style.display="none";
  });

  /** 載入送單模式 */
  async function loadOrderMode(){
    try{
      const res = await fetch("/api/orderMode");
      const data = await res.json();
      if(data.success && data.data){
        const mode = data.data;
        orderOpenCheckbox.checked = mode.open ?? false;
        scheduleEnabled.checked = mode.scheduleEnabled ?? false;
        scheduleDate.value = mode.scheduleDate ?? "";
        scheduleTime.value = mode.scheduleTime ?? "";
        orderStatus.textContent = mode.open ? "✅ 目前狀態：開放送單" : "❌ 目前狀態：未開放送單";
        orderStatus.style.color = mode.open ? "lightgreen" : "red";
      }
    } catch(err){ console.error(err); }
  }

  /** 儲存送單模式 */
  saveOrderModeBtn.addEventListener("click", async ()=>{
    const mode = {
      open: orderOpenCheckbox.checked,
      scheduleEnabled: scheduleEnabled.checked,
      scheduleDate: scheduleDate.value,
      scheduleTime: scheduleTime.value
    };
    try{
      const res = await fetch("/api/orderMode", {
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body:JSON.stringify(mode)
      });
      const data = await res.json();
      if(data.success) orderModeMsg.textContent="✅ 設定已儲存";
      else orderModeMsg.textContent="❌ 設定失敗";
      setTimeout(()=>orderModeMsg.textContent="",3000);
      loadOrderMode();
    } catch(err){ orderModeMsg.textContent="❌ 儲存失敗"; console.error(err); }
  });

  /** 刪除全部訂單 */
  deleteAllBtn.addEventListener("click", async ()=>{
    if(!confirm("⚠️ 確定要刪除全部訂單嗎？")) return;
    try{
      const res = await fetch("/api/orders/all", { method:"DELETE" });
      const data = await res.json();
      if(data.success){ alert("✅ 已刪除全部訂單"); loadStats(); }
      else alert("❌ 刪除失敗");
    } catch(err){ alert("❌ 刪除失敗"); console.error(err); }
  });

  /** 載入統計資料 */
  async function loadStats(){
    try{
      const res = await fetch("/api/orders/stats");
      const data = await res.json();
      const allOrders = data.allOrders || [];
      const dailyOrders = data.dailyOrders || [];

      // 座號訂單統計
      if(allOrders.length>0){
        statsResult.innerHTML = `
          <table>
            <tr>
              ${Object.keys(allOrders[0]).map(k=>`<th>${k}</th>`).join("")}<th>操作</th>
            </tr>
            ${allOrders.map(o=>`
              <tr>
                ${Object.values(o).map(v=>`<td>${v}</td>`).join("")}
                <td><button class="deleteSingleBtn" data-id="${o.id}">刪除</button></td>
              </tr>`).join("")}
          </table>
        `;
        document.querySelectorAll(".deleteSingleBtn").forEach(btn=>{
          btn.addEventListener("click", async ()=>{
            const orderId = btn.dataset.id;
            if(!confirm("⚠️ 確定刪除此訂單？")) return;
            try{
              const res = await fetch(`/api/orders/delete/${orderId}`, { method:"POST" });
              const result = await res.json();
              if(result.success){ alert("✅ 刪除成功"); loadStats(); }
              else alert("❌ 刪除失敗：" + (result.message||""));
            } catch(err){ alert("❌ 刪除失敗"); console.error(err); }
          });
        });
      } else statsResult.textContent="無訂單資料";

      // 每日訂單統計
      if(dailyOrders.length>0){
        dailyStatsResult.innerHTML = `
          <table>
            <tr>${Object.keys(dailyOrders[0]).map(k=>`<th>${k}</th>`).join("")}<th>操作</th></tr>
            ${dailyOrders.map(o=>`
              <tr>
                ${Object.values(o).map(v=>`<td>${v}</td>`).join("")}
                <td><button class="deleteDailyBtn" data-id="${o.id}">刪除</button></td>
              </tr>`).join("")}
          </table>
        `;
        document.querySelectorAll(".deleteDailyBtn").forEach(btn=>{
          btn.addEventListener("click", async ()=>{
            const orderId = btn.dataset.id;
            if(!confirm("⚠️ 確定刪除此每日訂單？")) return;
            try{
              const res = await fetch(`/api/orders/delete/${orderId}`, { method:"POST" });
              const result = await res.json();
              if(result.success){ alert("✅ 刪除成功"); loadStats(); }
              else alert("❌ 刪除失敗：" + (result.message||""));
            } catch(err){ alert("❌ 刪除失敗"); console.error(err); }
          });
        });
      } else dailyStatsResult.textContent="無每日訂單資料";

    } catch(err){ console.error(err); statsResult.textContent="❌ 連線失敗"; dailyStatsResult.textContent="❌ 連線失敗"; }
  }

});
</script>

<footer style="text-align:center; font-size:0.8em; color:#888; margin:20px 0;">
  ※如遇錯誤頁面刷新即可，bug反饋/忘記帳號密碼，聯繫方式(Gmail)：s11316021@fsvs.khc.edu.tw
</footer>

</body>
</html>
