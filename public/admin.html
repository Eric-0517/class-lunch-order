<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<title>後台管理 - 國二一便當訂購系統</title>
<link rel="stylesheet" href="./style.css">
<style>
body { font-family: Arial, sans-serif; background:#0b0f14; color:#cfe9ff; margin:0; padding:20px; }
header { display:flex; justify-content:space-between; align-items:center; padding:10px 20px; background:#111824; }
.logo { font-size:1.5em; font-weight:bold; }
button, .admin-link { cursor:pointer; color:#cfe9ff; background:none; border:none; text-decoration:none; font-size:1em; }
input, select { margin:5px 0; padding:5px; border-radius:4px; border:1px solid #37b7ff; background:#111824; color:#cfe9ff; }
#loginBtn { background:#37b7ff; color:#0b0f14; border:none; padding:8px 16px; border-radius:6px; margin-top:10px; }
#loginBtn:hover { background:#2a9edb; }
.delete-btn { background:red; color:#fff; border:none; padding:4px 8px; border-radius:4px; cursor:pointer; }
.delete-btn:hover { background:#a80000; }
table { border-collapse: collapse; width:100%; margin-top:15px; }
th, td { border:1px solid #37b7ff; padding:5px; text-align:center; }
#dailyStatsSection { margin-top:30px; }
footer { margin-top:20px; font-size:0.8em; color:#888; }
</style>
</head>
<body>

<header>
  <div class="logo">後台管理 - 國二一便當訂購系統</div>
  <a href="./index.html" class="admin-link">返回前台</a>
</header>

<main>
  <div id="adminPanel">
    <h2>所有訂單統計</h2>
    <div id="statsResult"></div>

    <div id="dailyStatsSection">
      <h2>每日訂單統計</h2>
      <div id="dailyStatsResult" style="margin-top:15px;"></div>
    </div>

    <button id="deleteAllBtn" class="delete-btn" style="margin-top:15px;">刪除全部訂單</button>
  </div>
</main>

<script>
const mealTypes = ["正園A","正園B","御饌A","御饌B","悦馨A","悦馨B","今日不訂購"];
let allOrders = []; // 全部訂單暫存

function loadOrders(){
  fetch("/api/orders")
    .then(res=>res.json())
    .then(data=>{
      if(data.success){
        allOrders = data.data;
        renderAllOrders(allOrders);
        renderDailyStats();
      }
    });
}

// 全部訂單統計
function renderAllOrders(orders){
  const seatMap = {};
  orders.forEach(o=>{
    const seat = o.seat;
    if(!seatMap[seat]) seatMap[seat]=[];
    seatMap[seat].push(o);
  });

  let html = `<table>
    <tr>
      <th>座號</th>
      <th>訂購日</th>
      <th>品項</th>
      <th>數量</th>
      <th>總金額</th>
      <th>操作</th>
    </tr>`;

  Object.keys(seatMap).forEach(seat=>{
    const items = seatMap[seat];
    const rowData = [];

    items.forEach(o=>{
      o.items.forEach(it=>{
        rowData.push({
          day: it.day,
          typeName: it.typeName
        });
      });
    });

    const counts = {};
    rowData.forEach(r=>{
      const key = `${r.day}_${r.typeName}`;
      counts[key] = (counts[key]||0)+1;
    });

    const totalPrice = rowData.reduce((sum,r)=>r.typeName!=="今日不訂購"?sum+70:sum,0);

    let first = true;
    Object.keys(counts).forEach(key=>{
      const [day,typeName] = key.split("_");
      html += `<tr>
        ${first?`<td rowspan="${Object.keys(counts).length}">${seat}</td>`:""}
        <td>${day}</td>
        <td>${typeName}</td>
        <td>${counts[key]}</td>
        ${first?`<td rowspan="${Object.keys(counts).length}">${totalPrice}</td>`:""}
        ${first?`<td rowspan="${Object.keys(counts).length}"><button class="delete-btn" data-seat="${seat}">刪除</button></td>`:""}
      </tr>`;
      first=false;
    });
  });

  html += `</table>`;
  document.getElementById('statsResult').innerHTML = html;

  bindDeleteButtons();
}

// 刪除按鈕
function bindDeleteButtons(){
  document.querySelectorAll(".delete-btn").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      const seat = btn.dataset.seat;
      if(confirm(`確認刪除座號 ${seat} 的所有訂單？`)){
        fetch("/api/orders", {
          method:"DELETE",
          headers:{"Content-Type":"application/json"},
          body:JSON.stringify({seat})
        })
        .then(res=>res.json())
        .then(d=>{
          if(d.success){
            alert("刪除成功");
            loadOrders();
          }
        });
      }
    });
  });
}

// 刪除全部訂單
document.getElementById('deleteAllBtn').addEventListener("click", ()=>{
  if(confirm("確認刪除全部訂單？")){
    fetch("/api/orders/all", { method:"DELETE" })
      .then(res=>res.json())
      .then(d=>{
        if(d.success){
          alert("全部訂單已刪除");
          loadOrders();
        }
      });
  }
});

// 每日統計
function renderDailyStats(){
  if(allOrders.length===0){
    document.getElementById('dailyStatsResult').innerHTML = "<p>目前沒有資料</p>";
    return;
  }

  const dayNames = ["禮拜一","禮拜二","禮拜三","禮拜四","禮拜五"];
  let html = "";

  dayNames.forEach(day=>{
    const dayOrders = allOrders.map(o=>{
      return o.items.filter(it=>it.day===day).map(it=>({typeName: it.typeName}));
    }).flat();

    const counts = {};
    mealTypes.forEach(t=>counts[t]=0);
    let totalAmount = 0;

    dayOrders.forEach(o=>{
      counts[o.typeName] = (counts[o.typeName]||0)+1;
      if(o.typeName!=="今日不訂購") totalAmount +=70;
    });

    html += `<h3>${day}</h3>`;
    html += `<table>
      <tr>${mealTypes.map(t=>`<th>${t}</th>`).join('')}<th>總金額</th></tr>
      <tr>${mealTypes.map(t=>`<td>${counts[t]}</td>`).join('')}<td>${totalAmount}</td></tr>
    </table>`;
  });

  document.getElementById('dailyStatsResult').innerHTML = html;
}

// 初始化
loadOrders();
</script>
<footer style="text-align:center; font-size:0.8em; color:#888; margin:20px 0;">
  ※如需更改便當數量或其他東西請找相關股長處理，bug反饋/聯繫方式(Gmail)：s11316021@fsvs.khc.edu.tw
</footer>
</body>
</html>
