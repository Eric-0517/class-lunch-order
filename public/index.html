<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>國二一便當訂購系統</title>
<link rel="stylesheet" href="style.css">
<style>
body {
  font-family: Arial, sans-serif;
  margin: 0;
  padding: 0;
}
header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  background: #f5f5f5;
  padding: 10px 20px;
  border-bottom: 1px solid #ddd;
}
.logo {
  font-size: 18px;
  font-weight: bold;
}
.header-buttons {
  display: flex;
  gap: 10px;
}
.btn {
  padding: 8px 14px;
  border: none;
  border-radius: 6px;
  cursor: pointer;
  font-size: 14px;
}
.btn-history {
  background-color: #2196f3;
  color: white;
}
.btn-login {
  background-color: #4caf50;
  color: white;
}
.btn:hover {
  opacity: 0.9;
}
main {
  padding: 20px;
}
.day-card {
  border: 1px solid #ddd;
  border-radius: 6px;
  padding: 10px;
  margin: 10px 0;
}
.day-card h3 {
  margin: 0 0 10px 0;
}
.summary {
  margin: 20px 0;
  font-size: 16px;
  font-weight: bold;
}
.submit-btn {
  padding: 10px 20px;
  font-size: 16px;
  border: none;
  border-radius: 6px;
  background-color: #ff9800;
  color: white;
  cursor: pointer;
}
.submit-btn:hover {
  opacity: 0.9;
}
.submit-btn.locked {
  background-color: red !important;
  cursor: not-allowed;
}
footer {
  text-align: center;
  font-size: 0.8em;
  color: #888;
  margin: 20px 0;
}
</style>
</head>
<body>
<header>
  <div class="logo">國二一便當訂購系統</div>
  <div class="header-buttons">
    <button class="btn btn-history" onclick="location.href='history.html'">歷史訂單</button>
    <button class="btn btn-login" onclick="location.href='admin.html'">後台登入</button>
  </div>
</header>

<main>
  <label>座號：
    <select id="seat-select">
      <option value="">請選擇座號</option>
    </select>
  </label>

  <div id="days-container"></div>

  <div class="summary">
    總金額：<span id="total-price">0</span> 元
  </div>

  <button id="submit-order" class="submit-btn">送出訂單</button>
</main>

<script>
// ====== 送單模式設定 ======
let orderMode = { open: true, closeTime: null };

// 從 localStorage 載入設定
function loadOrderMode() {
  const saved = localStorage.getItem("orderMode");
  if (saved) {
    try {
      orderMode = JSON.parse(saved);
    } catch(e) {}
  }
}

// 檢查送單是否允許
function checkOrderMode() {
  const btn = document.getElementById("submit-order");
  let locked = false;
  if (!orderMode.open) locked = true;
  if (orderMode.closeTime) {
    const now = new Date();
    const close = new Date(orderMode.closeTime);
    if (now >= close) locked = true;
  }
  if (locked) {
    btn.classList.add("locked");
  } else {
    btn.classList.remove("locked");
  }
  return !locked;
}

loadOrderMode();
checkOrderMode();

// ====== 原本功能 ======

// 動態產生座號選單
const seatSelect = document.getElementById('seat-select');
for (let i = 1; i <= 32; i++) {
  const opt = document.createElement('option');
  opt.value = i;
  opt.textContent = i;
  seatSelect.appendChild(opt);
}

// 星期與便當種類
const daysContainer = document.getElementById('days-container');
const dayNames = ['禮拜一','禮拜二','禮拜三','禮拜四','禮拜五'];
const types = ['正園A','正園B','御饌A','御饌B','悦馨','今日不訂購'];

// 建立每日選項卡片
dayNames.forEach(day => {
  const card = document.createElement('div');
  card.className = 'day-card';
  card.dataset.day = day;
  card.innerHTML = `<h3>${day}</h3>` +
    types.map(type => `
      <label>
        <input type="radio" name="${day}" value="${type}">
        ${type}
      </label>
    `).join('');
  daysContainer.appendChild(card);
});

// 更新金額
function updateTotal() {
  const items = [];
  document.querySelectorAll('.day-card').forEach(card => {
    const checked = card.querySelector('input[type=radio]:checked');
    items.push({ typeName: checked ? checked.value : '今日不訂購', quantity: 1 });
  });
  const total = items.reduce((sum, i) => sum + (i.typeName === '今日不訂購' ? 0 : 70), 0);
  document.getElementById('total-price').textContent = total;
}
document.addEventListener('change', updateTotal);

// 送出訂單
document.getElementById('submit-order').addEventListener('click', async () => {
  if (!checkOrderMode()) {
    return alert("系統未開放送單或時間到自動關閉系統！\n詳情聯繫：s11316021@fsvs.khc.edu.tw");
  }

  const seat = seatSelect.value;
  if (!seat) return alert("請選擇座號");

  const items = [];
  document.querySelectorAll('.day-card').forEach(card => {
    const checked = card.querySelector('input[type=radio]:checked');
    items.push({
      day: card.dataset.day,
      typeName: checked ? checked.value : '今日不訂購',
      quantity: 1
    });
  });

  const totalPrice = items.reduce((sum, i) => sum + (i.typeName === '今日不訂購' ? 0 : 70), 0);

  if (!confirm(`確認便當是否訂購無誤？\n共計金額：${totalPrice} 元`)) return;

  try {
    const res = await fetch('/api/order', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ seat, items })
    });
    const data = await res.json();
    alert(data.message);
    if (data.success) {
      document.querySelectorAll('input[type=radio]').forEach(r => r.checked = false);
      document.getElementById('total-price').textContent = 0;
    }
  } catch (err) {
    alert("訂單送出失敗：" + err.message);
  }
});
</script>

<footer>
  ※如需更改便當數量或其他需求請找相關股長處理<br>
  Bug回報 / 聯繫方式 (Gmail)：s11316021@fsvs.khc.edu.tw
</footer>
</body>
</html>
