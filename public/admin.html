<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<title>å¾Œå°ç®¡ç† - åœ‹äºŒä¸€ä¾¿ç•¶è¨‚è³¼ç³»çµ±</title>
<link rel="stylesheet" href="./style.css">
<style>
body { font-family: Arial, sans-serif; background:#0b0f14; color:#cfe9ff; margin:0; padding:20px; }
header { display:flex; justify-content:space-between; align-items:center; padding:10px 20px; background:#111824; }
.logo { font-size:1.5em; font-weight:bold; }
button, .admin-link { cursor:pointer; color:#cfe9ff; background:none; border:none; text-decoration:none; font-size:1em; }
input, select { margin:5px 0; padding:5px; border-radius:4px; border:1px solid #37b7ff; background:#111824; color:#cfe9ff; }
#loginBtn { background:#37b7ff; color:#0b0f14; border:none; padding:8px 16px; border-radius:6px; margin-top:10px; }
#loginBtn:hover { background:#2a9edb; }
.delete-btn { background:red; color:#fff; border:none; padding:4px 8px; border-radius:4px; cursor:pointer; }
.delete-btn:hover { background:#a80000; }
table { border-collapse: collapse; width:100%; margin-top:15px; }
th, td { border:1px solid #37b7ff; padding:5px; text-align:center; }
#dailyStatsSection { margin-top:30px; }
</style>
</head>
<body>

<header>
  <div class="logo">å¾Œå°ç®¡ç† - åœ‹äºŒä¸€ä¾¿ç•¶è¨‚è³¼ç³»çµ±</div>
  <a href="./index.html" class="admin-link">è¿”å›å‰å°</a>
</header>

<main>
  <div id="loginSection">
    <h2>ç®¡ç†å“¡ç™»å…¥</h2>
    <input type="text" id="adminUser" placeholder="å¸³è™Ÿ"><br>
    <input type="password" id="adminPass" placeholder="å¯†ç¢¼"><br>
    <button id="loginBtn">ç™»å…¥</button>
    <div id="loginMsg" style="color:red; margin-top:10px;"></div>
  </div>

  <div id="adminPanel" style="display:none;">
    <h2>æ‰€æœ‰è¨‚å–®çµ±è¨ˆ</h2>
    <div id="statsResult"></div>

    <div id="dailyStatsSection">
      <h2>æ¯æ—¥è¨‚å–®çµ±è¨ˆ</h2>
      <label>é¸æ“‡ç¦®æ‹œï¼š
        <select id="daySelect">
          <option value="">è«‹é¸æ“‡</option>
          <option value="ç¦®æ‹œä¸€">ç¦®æ‹œä¸€</option>
          <option value="ç¦®æ‹œäºŒ">ç¦®æ‹œäºŒ</option>
          <option value="ç¦®æ‹œä¸‰">ç¦®æ‹œä¸‰</option>
          <option value="ç¦®æ‹œå››">ç¦®æ‹œå››</option>
          <option value="ç¦®æ‹œäº”">ç¦®æ‹œäº”</option>
        </select>
      </label>
      <div id="dailyStatsResult" style="margin-top:15px;"></div>
    </div>

    <button id="deleteAllBtn" class="delete-btn" style="margin-top:15px;">åˆªé™¤å…¨éƒ¨è¨‚å–®</button>
  </div>
</main>

<script>
const loginSection = document.getElementById("loginSection");
const adminPanel = document.getElementById("adminPanel");
const loginBtn = document.getElementById("loginBtn");
const loginMsg = document.getElementById("loginMsg");
const statsResult = document.getElementById("statsResult");
const daySelect = document.getElementById("daySelect");
const dailyStatsResult = document.getElementById("dailyStatsResult");
const deleteAllBtn = document.getElementById("deleteAllBtn");

const mealTypes = ["æ­£åœ’A","æ­£åœ’B","å¾¡é¥ŒA","å¾¡é¥ŒB","æ‚¦é¦¨A","æ‚¦é¦¨B","ä»Šæ—¥ä¸è¨‚è³¼"];
let allOrders = []; // å…¨éƒ¨è¨‚å–®æš«å­˜

// ç™»å…¥åŠŸèƒ½
loginBtn.addEventListener("click", () => {
  const username = document.getElementById("adminUser").value;
  const password = document.getElementById("adminPass").value;

  fetch("/api/admin/login", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ user: username, pass: password })
  })
  .then(res => res.json())
  .then(data => {
    if(data.success){
      loginSection.style.display="none";
      adminPanel.style.display="block";
      loginMsg.textContent="";
      loadOrders();
    } else {
      loginMsg.textContent="å¸³è™Ÿæˆ–å¯†ç¢¼éŒ¯èª¤";
    }
  })
  .catch(err => {
    loginMsg.textContent="ç™»å…¥å¤±æ•—ï¼š" + err.message;
  });
});

// è¼‰å…¥æ‰€æœ‰è¨‚å–®
function loadOrders(){
  fetch("/api/orders")
    .then(res=>res.json())
    .then(data=>{
      if(data.success){
        allOrders = data.data;
        renderAllOrders(allOrders);
      } else {
        statsResult.innerHTML=`<div style="color:red">${data.message}</div>`;
      }
    })
    .catch(err=>{
      statsResult.innerHTML=`<div style="color:red">è¼‰å…¥å¤±æ•—ï¼š${err.message}</div>`;
    });
}

// æ¸²æŸ“æ‰€æœ‰è¨‚å–®çµ±è¨ˆ
function renderAllOrders(orders){
  const seatMap = {};
  orders.forEach(o=>{
    if(!seatMap[o.seat]) seatMap[o.seat]=[];
    seatMap[o.seat].push(...o.items.map(item=>({ typeName: item.typeName })));
  });

  let html = `<table>
    <tr>
      <th>åº§è™Ÿ</th>
      <th>å“é …</th>
      <th>æ•¸é‡</th>
      <th>ç¸½é‡‘é¡</th>
      <th>æ“ä½œ</th>
    </tr>`;

  Object.keys(seatMap).forEach(seat=>{
    const items = seatMap[seat];
    const counts = {};
    items.forEach(i=>{
      counts[i.typeName] = (counts[i.typeName]||0)+1;
    });
    const totalPrice = items.reduce((sum,i)=>(i.typeName==="ä»Šæ—¥ä¸è¨‚è³¼"?0:70)+sum,0);
    let first = true;
    for(let type in counts){
      html += `<tr>
        ${first?`<td rowspan="${Object.keys(counts).length}">${seat}</td>`:""}
        <td>${type}</td>
        <td>${counts[type]}</td>
        ${first?`<td rowspan="${Object.keys(counts).length}">${totalPrice}</td>`:""}
        ${first?`<td rowspan="${Object.keys(counts).length}"><button class="delete-btn" data-seat="${seat}">åˆªé™¤</button></td>`:""}
      </tr>`;
      first=false;
    }
  });

  html += `</table>`;
  statsResult.innerHTML = html;

  bindDeleteButtons();
}

// ç¶å®šåˆªé™¤æŒ‰éˆ•
function bindDeleteButtons(){
  document.querySelectorAll(".delete-btn").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      const seat = btn.dataset.seat;
      if(confirm(`ç¢ºèªåˆªé™¤åº§è™Ÿ ${seat} çš„æ‰€æœ‰è¨‚å–®ï¼Ÿ`)){
        fetch("/api/orders", {
          method:"DELETE",
          headers:{"Content-Type":"application/json"},
          body:JSON.stringify({seat})
        })
        .then(res=>res.json())
        .then(d=>{
          if(d.success){
            alert("åˆªé™¤æˆåŠŸ");
            loadOrders();
            dailyStatsResult.innerHTML="";
          } else {
            alert(d.message);
          }
        });
      }
    });
  });
}

// åˆªé™¤å…¨éƒ¨è¨‚å–®
deleteAllBtn.addEventListener("click", ()=>{
  if(confirm("ç¢ºèªåˆªé™¤å…¨éƒ¨è¨‚å–®ï¼Ÿ")){
    fetch("/api/orders/all", { method:"DELETE" })
      .then(res=>res.json())
      .then(d=>{
        if(d.success){
          alert("å…¨éƒ¨è¨‚å–®å·²åˆªé™¤");
          loadOrders();
          dailyStatsResult.innerHTML="";
        } else {
          alert(d.message);
        }
      });
  }
});

// ğŸ”¹ æ¯æ—¥è¨‚å–®çµ±è¨ˆï¼ˆå·²ä¿®æ­£ï¼‰
daySelect.addEventListener("change", ()=>{
  const day = daySelect.value;
  if(!day){ dailyStatsResult.innerHTML=""; return; }

  const dayOrders = allOrders.filter(o => 
    o.items.some(item => item.day === day)
  );

  const counts = {};
  mealTypes.forEach(t=>counts[t]=0);
  let totalAmount = 0;

  dayOrders.forEach(o=>{
    o.items.forEach(item=>{
      if(item.day===day){
        counts[item.typeName] = (counts[item.typeName]||0)+1;
        if(item.typeName!=="ä»Šæ—¥ä¸è¨‚è³¼") totalAmount+=70;
      }
    });
  });

  let html = `<h3>${day} è¨‚å–®çµ±è¨ˆ</h3>`;
  html += `<table>
    <tr>${mealTypes.map(t=>`<th>${t}</th>`).join('')}<th>ç¸½é‡‘é¡</th></tr>`;
  html += `<tr>${mealTypes.map(t=>`<td>${counts[t]}</td>`).join('')}<td>${totalAmount}</td></tr>`;
  html += `</table>`;

  dailyStatsResult.innerHTML = html;
});
</script>
<footer style="text-align:center; font-size:0.8em; color:#888; margin:20px 0;">
  â€»å¦‚éœ€æ›´æ”¹ä¾¿ç•¶æ•¸é‡æˆ–å…¶ä»–æ±è¥¿è«‹æ‰¾ç›¸é—œè‚¡é•·è™•ç†ï¼Œbugåé¥‹/è¯ç¹«æ–¹å¼(Gmail)ï¼šs11316021@fsvs.khc.edu.tw
</footer>
</body>
</html>
