<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>國二一便當訂購系統</title>
<link rel="stylesheet" href="style.css">
<style>
header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  background: #0b0f14;
  padding: 10px 20px;
}
.logo {
  font-size: 18px;
  font-weight: bold;
  color: #cfe9ff;
}
.header-buttons {
  display: flex;
  gap: 10px;
}
.btn {
  padding: 8px 14px;
  border: none;
  border-radius: 6px;
  cursor: pointer;
  font-size: 14px;
}
.btn-history {
  background-color: #2196f3;
  color: white;
}
.btn-notice {
  background-color: #ff9800;
  color: white;
}
.btn-login {
  background-color: #4caf50;
  color: white;
}
.btn:hover {
  opacity: 0.9;
}
main {
  padding: 20px;
}
.day-card {
  border: 1px solid #ddd;
  border-radius: 6px;
  padding: 10px;
  margin: 10px 0;
}
.day-card h3 {
  margin: 0 0 10px 0;
}
.summary {
  margin: 20px 0;
  font-size: 16px;
  font-weight: bold;
}
.submit-btn {
  padding: 10px 20px;
  font-size: 16px;
  border: none;
  border-radius: 6px;
  cursor: pointer;
  background-color: #2196f3;
  color: white;
}
.submit-btn.locked {
  background-color: #f44336;
  cursor: not-allowed;
}
.submit-btn.locked::after {
  content: "🔒";
  margin-left: 5px;
  font-weight: bold;
}
.submit-btn:hover:not(.locked) {
  opacity: 0.9;
}
footer {
  text-align: center;
  font-size: 0.8em;
  color: #888;
  margin: 20px 0;
}
</style>
</head>
<body>
<header>
  <div class="logo">國二一便當訂購系統</div>
  <div class="header-buttons">
    <button class="btn btn-history" onclick="location.href='history.html'">歷史訂單</button>
    <button class="btn btn-notice" onclick="location.href='notice/index.html'">公告</button>
    <button class="btn btn-login" onclick="location.href='admin.html'">後台登入</button>
  </div>
</header>

<main>
  <label>座號：
    <select id="seat-select">
      <option value="">請選擇座號</option>
    </select>
  </label>

  <div id="days-container"></div>

  <div class="summary">
    總金額：<span id="total-price">0</span> 元
  </div>

  <button id="submit-order" class="submit-btn">送出訂單</button>
</main>

<script>
// 產生座號選單
const seatSelect = document.getElementById('seat-select');
for(let i=1;i<=32;i++){
  const opt = document.createElement('option');
  opt.value = i;
  opt.textContent = i;
  seatSelect.appendChild(opt);
}

// 星期與便當種類
const daysContainer = document.getElementById('days-container');
const dayNames = ['禮拜一','禮拜二','禮拜三','禮拜四','禮拜五'];
const types = ['正園A','正園B','御饌A','御饌B','悦馨','今日不訂購'];

// 建立每日選項卡片
dayNames.forEach(day=>{
  const card = document.createElement('div');
  card.className='day-card';
  card.dataset.day=day;
  card.innerHTML = `<h3>${day}</h3>` +
    types.map(type=>`
       <label>
         <input type="radio" name="${day}" value="${type}">
         ${type}
       </label>
     `).join('');
  daysContainer.appendChild(card);
});

// 更新總金額
function updateTotal(){
  const items=[];
  document.querySelectorAll('.day-card').forEach(card=>{
    const checked = card.querySelector('input[type=radio]:checked');
    items.push({ typeName: checked ? checked.value : '今日不訂購', quantity:1 });
  });
  const total = items.reduce((sum,i)=>sum + (i.typeName==='今日不訂購'?0:70),0);
  document.getElementById('total-price').textContent=total;
}
document.addEventListener('change',updateTotal);

// 控制送單按鈕狀態
const submitBtn = document.getElementById('submit-order');
function updateSubmitButton() {
  const saved = localStorage.getItem("orderMode");
  if(saved){
    try{
      const mode = JSON.parse(saved);
      if(!mode.open){
        submitBtn.classList.add('locked');
        submitBtn.disabled = true;
      } else {
        submitBtn.classList.remove('locked');
        submitBtn.disabled = false;
      }
    }catch(e){
      submitBtn.classList.remove('locked');
      submitBtn.disabled = false;
    }
  } else {
    // 預設開放送單
    submitBtn.classList.remove('locked');
    submitBtn.disabled = false;
  }
}
updateSubmitButton();

// 點擊送單
submitBtn.addEventListener('click', async ()=>{
  if(submitBtn.disabled) return; // 上鎖時不執行

  const seat = seatSelect.value;
  if(!seat) return alert("請選擇座號");

  const items=[];
  document.querySelectorAll('.day-card').forEach(card=>{
    const checked = card.querySelector('input[type=radio]:checked');
    items.push({ 
      day: card.dataset.day,
      typeName: checked ? checked.value : '今日不訂購',
      quantity: 1
    });
  });

  const totalPrice = items.reduce((sum,i)=>sum + (i.typeName==='今日不訂購'?0:70),0);

  // ✅ 第一步：確認是否正確
  if(!confirm(`確認便當是否訂購無誤？\n共計金額：${totalPrice} 元`)) return;

  try{
    const res = await fetch('/api/order',{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({seat,items})
    });
    const data = await res.json();
    if(data.success){
      document.querySelectorAll('input[type=radio]').forEach(r=>r.checked=false);
      document.getElementById('total-price').textContent=0;

      // ✅ 第二步：成功提示
      alert("訂購成功！\n請至歷史訂單頁面查看！");
    }
  }catch(err){
    console.error("訂單送出失敗：" + err.message);
  }
});
</script>

<footer>
  ※如遇錯誤頁面刷新即可，需更改便當數量或其他東西請找相關股長處理，bug反饋/聯繫方式(Gmail)：s11316021@fsvs.khc.edu.tw
</footer>
</body>
</html>
