<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>後台管理 - 國二一便當訂購系統</title>
<link rel="stylesheet" href="./style.css">
<style>
body { font-family: Arial, sans-serif; background:#0b0f14; color:#cfe9ff; margin:0; padding:20px; }
header { display:flex; justify-content:space-between; align-items:center; padding:10px 20px; background:#111824; }
.logo { font-size:1.5em; font-weight:bold; }
.header-buttons { display:flex; gap:10px; }
.admin-link, .logout-btn { color:#cfe9ff; text-decoration:none; font-size:1em; font-weight:bold; background:#2196f3; padding:6px 12px; border-radius:4px; cursor:pointer; display:inline-flex; align-items:center; justify-content:center; height:36px; }
.logout-btn:hover, .admin-link:hover { opacity:0.9; }

.delete-btn { background:red; color:#fff; border:none; padding:4px 8px; border-radius:4px; cursor:pointer; }
.delete-btn:hover { background:#a80000; }
table { border-collapse: collapse; width:100%; margin-top:15px; }
th, td { border:1px solid #37b7ff; padding:5px; text-align:center; }
#dailyStatsSection { margin-top:30px; }
footer { margin-top:30px; font-size:0.8em; color:#888; }

/* 輸入框樣式 */
.input-field {
  width: 250px;
  padding: 8px 12px;
  margin: 5px 0;
  border-radius: 6px;
  border: 1px solid #37b7ff;
  background: #111824;
  color: #cfe9ff;
}

/* 登入按鈕 */
.login-btn {
  padding: 8px 20px;
  margin-top: 10px;
  border: none;
  border-radius: 6px;
  background-color: #4caf50;
  color: white;
  font-size: 14px;
  cursor: pointer;
}
.login-btn:hover { opacity: 0.9; }

/* 送單模式區塊 */
#orderModeSection { margin-top:30px; border:1px solid #37b7ff; padding:15px; border-radius:6px; }
#orderModeSection button { margin-top:10px; padding:6px 12px; border:none; border-radius:6px; background:#2196f3; color:white; cursor:pointer; }
#orderModeSection button:hover { opacity:0.9; }
.active { color: #4caf50; font-weight: bold; }
.inactive { color: #f44336; font-weight: bold; }
</style>
</head>
<body>

<header>
  <div class="logo">後台管理 - 國二一便當訂購系統</div>
  <div class="header-buttons">
    <a href="./index.html" class="admin-link">返回前台</a>
    <span class="logout-btn" id="logoutBtn" style="display:none;">登出</span>
  </div>
</header>

<main>
  <!-- 登入區 -->
  <div id="loginSection">
    <h2>管理員登入</h2>
    <input type="text" id="adminUser" placeholder="帳號" class="input-field"><br>
    <input type="password" id="adminPass" placeholder="密碼" class="input-field"><br>
    <button id="loginBtn" class="login-btn">登入</button>
    <div id="loginMsg" style="color:red; margin-top:10px;"></div>
  </div>

  <!-- 後台統計區 -->
  <div id="adminPanel" style="display:none;">
    <h2>所有訂單統計</h2>
    <div id="statsResult"></div>

    <div id="dailyStatsSection">
      <h2>每日訂單統計</h2>
      <div id="dailyStatsResult" style="margin-top:15px;"></div>
    </div>

    <button id="deleteAllBtn" class="delete-btn" style="margin-top:15px;">刪除全部訂單</button>

    <!-- ===== 送單模式設定 ===== -->
    <div id="orderModeSection">
      <h2>📦 送單模式設定</h2>
      <p>目前狀態：<span id="orderStatusText" class="inactive">送單已關閉</span></p>

      <h3>手動模式</h3>
      <button onclick="toggleOrder(true)">開啟送單</button>
      <button onclick="toggleOrder(false)">關閉送單</button>

      <h3 style="margin-top:15px;">定時自動關閉</h3>
      <input type="datetime-local" id="closeTime">
      <br>
      <button onclick="setAutoClose()">設定自動關閉</button>
      <button onclick="clearAutoClose()">取消自動關閉</button>
      <p id="scheduleInfo" style="margin-top:10px;color:#ff9800;"></p>
    </div>
  </div>
</main>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const loginSection = document.getElementById("loginSection");
  const adminPanel = document.getElementById("adminPanel");
  const loginBtn = document.getElementById("loginBtn");
  const loginMsg = document.getElementById("loginMsg");
  const logoutBtn = document.getElementById("logoutBtn");

  let inactivityTimer = null;
  const INACTIVITY_LIMIT = 10 * 60 * 1000; // 10分鐘
  let allOrders = [];

  const orderStatusText = document.getElementById("orderStatusText");
  const scheduleInfo = document.getElementById("scheduleInfo");
  let orderOpen = false;
  let autoCloseTime = null;

  // ===== 自動登出 =====
  function resetInactivityTimer() {
    if(inactivityTimer) clearTimeout(inactivityTimer);
    inactivityTimer = setTimeout(() => {
      alert("已超過10分鐘未操作，為保護資訊安全，系統已自動將您登出");
      logout();
    }, INACTIVITY_LIMIT);
  }
  ['click','mousemove','keydown','scroll'].forEach(evt => {
    document.addEventListener(evt, resetInactivityTimer);
  });
  function logout() {
    localStorage.removeItem("loginTime");
    adminPanel.style.display = "none";
    loginSection.style.display = "block";
    logoutBtn.style.display = "none";
  }
  logoutBtn.addEventListener("click", logout);

  // ===== 登入功能 =====
  loginBtn.addEventListener("click", async () => {
    const username = document.getElementById("adminUser").value.trim();
    const password = document.getElementById("adminPass").value.trim();
    if(!username || !password){ loginMsg.textContent="請輸入帳號與密碼"; return; }

    try {
      const res = await fetch("/api/admin/login", {
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body:JSON.stringify({user:username, pass:password})
      });
      const data = await res.json();
      if(data.success){
        loginSection.style.display="none";
        adminPanel.style.display="block";
        logoutBtn.style.display = "inline-flex";
        loginMsg.textContent="";
        localStorage.setItem("loginTime", Date.now());
        resetInactivityTimer();
        loadOrders();
        loadOrderMode();
      } else loginMsg.textContent=data.message || "帳號或密碼錯誤";
    } catch(err){
      loginMsg.textContent = "登入失敗：" + err.message;
    }
  });

  // ===== 檢查是否已登入 =====
  const savedLogin = localStorage.getItem("loginTime");
  if(savedLogin && (Date.now() - savedLogin < INACTIVITY_LIMIT)){
    loginSection.style.display="none";
    adminPanel.style.display="block";
    logoutBtn.style.display = "inline-flex";
    resetInactivityTimer();
    loadOrders();
    loadOrderMode();
  }

  // ===== 訂單載入 =====
  async function loadOrders(){
    try {
      const res = await fetch("/api/orders");
      const data = await res.json();
      if(data.success){
        allOrders = data.data;
      }
    } catch(err){ alert("載入訂單失敗：" + err.message); }
  }

  // ===== 送單模式功能 =====
  window.toggleOrder = function(open) {
    orderOpen = open;
    saveOrderMode();
    updateOrderUI();
  }

  window.setAutoClose = function() {
    const input = document.getElementById("closeTime").value;
    if(!input){ alert("請選擇日期與時間！"); return; }
    autoCloseTime = new Date(input);
    saveOrderMode();
    updateOrderUI();
    checkAutoClose();
  }

  window.clearAutoClose = function() {
    autoCloseTime = null;
    saveOrderMode();
    updateOrderUI();
  }

  function checkAutoClose() {
    if(autoCloseTime && new Date() >= autoCloseTime){
      orderOpen = false;
      autoCloseTime = null;
      saveOrderMode();
      updateOrderUI();
    }
  }

  function updateOrderUI() {
    if(orderOpen){
      orderStatusText.textContent = "送單已開啟";
      orderStatusText.className = "active";
    } else {
      orderStatusText.textContent = "送單已關閉";
      orderStatusText.className = "inactive";
    }
    if(autoCloseTime){
      scheduleInfo.textContent = "⏰ 預計關閉時間：" + autoCloseTime.toLocaleString();
    } else {
      scheduleInfo.textContent = "";
    }
  }

  function saveOrderMode() {
    const mode = { open: orderOpen, autoCloseTime: autoCloseTime ? autoCloseTime.toISOString() : null };
    localStorage.setItem("orderMode", JSON.stringify(mode));
  }

  function loadOrderMode() {
    const saved = localStorage.getItem("orderMode");
    if(saved){
      try {
        const mode = JSON.parse(saved);
        orderOpen = mode.open ?? false;
        autoCloseTime = mode.autoCloseTime ? new Date(mode.autoCloseTime) : null;
      } catch(e){}
    }
    checkAutoClose();
    updateOrderUI();
  }

  setInterval(checkAutoClose, 10000);
});
</script>

<footer style="text-align:center; font-size:0.8em; color:#888; margin:20px 0;">
  ※如遇錯誤頁面刷新即可，需更改便當數量或其他東西請找相關股長處理，bug反饋/忘記帳號密碼，聯繫方式(Gmail)：s11316021@fsvs.khc.edu.tw
</footer>

</body>
</html>
